/**
 * @module mmp
 * @version 0.1.3
 * @file JavaScript UMD module & logic engine to create mind maps applications
 * @copyright Omar Desogus 2017
 * @license MIT
 * @see {@link https://github.com/cedoor/mmp|GitHub}
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],t):t(e.mmp=e.mmp||{},e.d3)}(this,function(e,t){"use strict";function n(e,t,n){S(),o(function(o){var r=new Image;r.src=o,r.onload=function(){var o=document.createElement("canvas"),i=o.getContext("2d");o.width=r.width,o.height=r.height,i.drawImage(r,0,0),i.globalCompositeOperation="destination-over",i.fillStyle=n||"#ffffff",i.fillRect(0,0,o.width,o.height),"string"==typeof t&&(t="image/"+t),e(o.toDataURL(t))},r.onerror=function(){fe.error("The image has not been loaded")}})}function o(e){var t=ie.svg.mmp.node(),n=t.cloneNode(!0),o=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=t.getBBox(),c=r(t),s="http://www.w3.org/2000/xmlns/",l=a.x-15,d=a.y-15,u=a.width+30,h=a.height+30;if(o.setAttributeNS(s,"xmlns","http://www.w3.org/2000/svg"),o.setAttributeNS(s,"xmlns:xlink","http://www.w3.org/1999/xlink"),o.setAttribute("version","1.1"),o.setAttribute("width",u),o.setAttribute("height",h),o.setAttribute("viewBox",[l,d,u,h].join(" ")),""!==c){var f=document.createElement("style"),v=document.createElement("defs");f.setAttribute("type","text/css"),f.innerHTML="<![CDATA[\n"+c+"\n]]>",v.appendChild(f),o.appendChild(v)}n.setAttribute("transform","translate(0,0)"),o.appendChild(n),i(n,function(){var t=new XMLSerializer,n=new window.FileReader,r=new Blob([t.serializeToString(o)],{type:"image/svg+xml"});n.readAsDataURL(r),n.onloadend=function(){e(n.result)}})}function r(e){for(var t="",n=document.styleSheets,o=0;o<n.length;o++){var r=n[o].cssRules;if(r)for(var i=0;i<r.length;i++){var a=r[i],c=a.cssText.match(/^@font-face/);(e.querySelector(a.selectorText)||c)&&(t+=a.cssText)}}return t}function i(e,t){var n=e.querySelectorAll("image"),o=n.length,r=o;if(o>0){var i=!0,a=!1,c=void 0;try{for(var s,l=n[Symbol.iterator]();!(i=(s=l.next()).done);i=!0)!function(){var e=s.value,n=document.createElement("canvas"),o=n.getContext("2d"),i=new Image,a=e.getAttribute("href");i.crossOrigin="Anonymous",i.src=a,i.onload=function(){n.width=this.width,n.height=this.height,o.drawImage(this,0,0),e.setAttribute("href",n.toDataURL("image/png")),0===--r&&t()},i.onerror=function(){0===--r&&t()}}()}catch(e){a=!0,c=e}finally{try{!i&&l.return&&l.return()}finally{if(a)throw c}}}else t()}function a(e){if(!f(e))return ie.history.snapshots[ie.history.index];d(e),p(),l()}function c(){var e=ie.history;e.index>0&&(d(e.snapshots[--e.index]),he.call("mmundo"))}function s(){var e=ie.history;e.index<e.snapshots.length-1&&(d(e.snapshots[++e.index]),he.call("mmrepeat"))}function l(){var e=ie.history;e.index<e.snapshots.length-1&&e.snapshots.splice(e.index+1),e.snapshots.push(u()),e.index++}function d(e){ie.nodes.clear(),e.forEach(function(e){ie.nodes.set(e.key,fe.cloneObject(e.value))}),w(),h(),S()}function u(){return ie.nodes.entries().map(function(e){var t=fe.cloneObject(e.value);return delete t.width,delete t.height,{key:e.key,value:t}})}function h(){var e=ie.nodes.keys().map(function(e){return parseInt(e.substring(4))});ie.counter=Math.max.apply(Math,de(e))}function f(e){return void 0!==e&&(!(e.constructor!==Array||"node0"!==e[0].key||!v(e))||fe.error("The loaded mind map is incorrect"))}function v(e){var t=!0,n=!1,o=void 0;try{for(var r,i=e[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var a=r.value;if("string"!=typeof a.key||a.value.constructor!==Object)return!1}}catch(e){n=!0,o=e}finally{try{!t&&i.return&&i.return()}finally{if(n)throw o}}return!0}function g(){b(!0)}function m(){b(!1)}function p(){var e=ie.nodes.get("node0"),n=parseInt(ie.container.style("width"))/2-e.x,o=parseInt(ie.container.style("height"))/2-e.y,r=t.zoomIdentity.translate(n,o);ie.svg.main.transition().duration(500).call(ve.transform,r),he.call("mmcenter")}function y(){ie.svg.mmp.attr("transform",t.event.transform)}function b(e){var n=ie.svg.main,o=t.zoomTransform(n.node()).k;o+=e?o/5:-o/5,ve.scaleTo(n.transition().duration(100),o)}function x(){var e=ie.nodes.entries(),n=ie.svg.mmp.selectAll(".node").data(e),o=ie.svg.mmp.selectAll(".branch").data(e.slice(1)),r=n.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",function(e){return e.key}).attr("transform",function(e){return"translate("+e.value.x+","+e.value.y+")"}).on("dblclick",function(){t.event.stopPropagation(),fe.focusWithCaretAtEnd(this.childNodes[1].childNodes[0])});!0===ie.options.drag&&r.call(be),r.insert("foreignObject").html(function(e){return'<div style="\n            font-size: '+e.value["font-size"]+"px;\n            display: inline-block;\n            white-space: nowrap;\n            color: "+e.value["text-color"]+";\n            font-style: "+fe.fontStyle(e.value.italic)+";\n            font-weight: "+fe.fontStyle(e.value.bold)+';\n            text-align: center;\n        " contenteditable spellcheck="false">'+e.value.name+"</div>"}).each(k),r.insert("path","foreignObject").style("fill",function(e){return e.value["background-color"]}).style("stroke-width",3).attr("d",function(e){return new me(e,this).draw()}),r.each(function(e){R(t.select(this),e.value)}),o.enter().insert("path","g").style("fill",function(e){return e.value["branch-color"]}).style("stroke",function(e){return e.value["branch-color"]}).attr("class","branch").attr("id",function(e){return"branchOf"+e.key}).attr("d",function(e){return new pe(e).draw()}),n.exit().remove(),o.exit().remove()}function w(){t.selectAll(".node, .branch").remove(),x()}function k(e){var n=this,o=this.childNodes[0];o.oninput=function(){L(n.parentNode)},o.onblur=function(){o.innerHTML!==e.value.name&&(e.value.name=o.innerHTML,l())},t.select(n).attr("x",-o.clientWidth/2).attr("y",-o.clientHeight/2).attr("width",o.clientWidth).attr("height",o.clientHeight)}function A(){ie.counter=0,ie.nodes.clear(),w(),he.call("mmcreate",ie.container.node()),j(),p(),l()}function O(e,n){ie.backup=fe.cloneObject(ie,!0),void 0!==n&&(n.constructor===Object?fe.overwriteObject(ie.options,n):fe.error("mmp options are invalid")),ie.container=t.select("#"+e).style("position","relative"),ie.svg.main=ie.container.append("svg").style("position","absolute").style("width","100%").style("height","100%").style("top",0).style("left",0),ie.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",S),ie.svg.mmp=ie.svg.main.append("g"),ie.nodes=t.map(),ie.counter=0,ie.history.index=-1,ie.history.snapshots=[],!0===ie.options["center-onresize"]&&(onresize=p),!0===ie.options.zoom&&ie.svg.main.call(ve),he.call("mmcreate",ie.container.node()),j()}function z(){if(void 0!==ie.container){ie.container.select("svg").remove();var e=fe.cloneObject(ie.backup);fe.clearObject(ie),Object.assign(ie,e)}}function N(e){var t=ie.nodes.get(ie.selected),n="node"+ ++ie.counter,o=ie.options.node;T(n,Object.assign({},{name:e&&e.name||o.name,"background-color":e&&e["background-color"]||o["background-color"],"text-color":e&&e["text-color"]||o["text-color"],"branch-color":e&&e["branch-color"]||t["branch-color"]||o["branch-color"],"image-src":e&&e["image-src"]||o["image-src"],"image-size":e&&e["image-size"]||o["image-size"],"font-size":e&&e["font-size"]||o["font-size"],italic:e&&e.italic||o.italic,bold:e&&e.bold||o.bold,fixed:e&&e.fixed||o.fixed,x:e&&e.x||U(t.x),y:e&&e.y||q(t.y),parent:ie.selected}))}function j(){var e=Object.assign({x:parseInt(ie.container.style("width"))/2,y:parseInt(ie.container.style("height"))/2},ie.options["root-node"]);T("node"+ie.counter,e),S()}function T(e,t){ie.nodes.set(e,t),x(),he.call("nodecreate",ye(e),e,t),l()}function E(e){var n=ie.selected;if("string"!=typeof e)return{key:n,value:fe.cloneObject(ie.nodes.get(n))};if(ie.nodes.has(e)){var o=ye(e),r=o.childNodes[0];if(0===r.style.stroke.length){n&&ie.nodes.has(n)&&D(n,"");var i=t.color(r.style.fill).darker(.5);r.style.stroke=i,ie.selected=e,he.call("nodeselect",o,e,ie.nodes.get(e))}}else fe.error("The node with the key "+e+" don't exist")}function S(){E("node0"),D("node0","")}function C(e){var t="up"===e||"left"===e;"up"===e||"down"===e?I(t):_(t)}function I(e){var t=ie.nodes.get(ie.selected),n=H(t),o=B(t.x),r=void 0,i=Number.MAX_VALUE;ie.nodes.each(function(a,c){var s=e?t.y-a.y:a.y-t.y;n===H(a)&&ie.selected!==c&&o===B(a.x)&&s>0&&s<i&&(i=s,r=c)}),void 0!==r&&E(r)}function _(e){var t=ie.nodes.get(ie.selected),n=ie.nodes.get("node0"),o=void 0,r=void 0,i=Number.MIN_VALUE;ie.nodes.each(function(a,c){(r=t.x<n.x?e?a.parent===ie.selected:t.parent===c:t.x>n.x?e?t.parent===c:a.parent===ie.selected:(e?a.x<n.x:a.x>n.x)&&a.parent===ie.selected)&&a.y>i&&(i=a.y,o=c)}),void 0!==o&&E(o)}function M(){var e=ie.selected;"node0"!==e?(ie.nodes.remove(e),W(e,function(e,t){ie.nodes.remove(t)}),E("node0"),w(),l(),he.call("noderemove",null,e)):fe.error("The root node can not be deleted")}function B(e){var t=ie.nodes.get("node0");return e<t.x||!(e>t.x)&&void 0}function R(e,t){var n=new Image,o=t["image-src"],r=e.select("image");r.empty()&&(r=e.append("image")),n.src=o,n.onload=function(){var e=t["image-size"],n=this.width*e/this.height;r.attr("href",o).attr("height",e).attr("y",-(e+t.height/2+5)).attr("x",-n/2)},n.onerror=function(){r.remove(),t["image-src"]=""}}function L(e){var n=e.childNodes[1].childNodes[0],o=e.childNodes[0];t.selectAll(".branch").attr("d",function(e){return new pe(e).draw()}),t.select(o).attr("d",function(e){return new me(e,this).draw()}),t.select(n.parentNode).attr("x",-n.clientWidth/2).attr("y",-n.clientHeight/2).attr("width",n.clientWidth).attr("height",n.clientHeight)}function H(e){for(var t=e.parent,n=0;t;)n++,t=ie.nodes.get(t).parent;return n}function P(e){return ie.nodes.values().filter(function(t){return t.parent===e})}function W(e,t){ie.nodes.each(function(n,o){n.parent===e&&(t.call(document.getElementById(o),n,o),W(o,t))})}function D(e,t){var n=ye(e).childNodes[0];return"string"==typeof t?n.style.stroke=t:n.style.stroke}function U(e){var t=B(e);return e+200*(!0===t?-1:!1===t?1:P("node0").length%2==0?-1:1)}function q(e){return e-t.randomUniform(60,100)()}function J(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,o=ie.nodes.get(ie.selected),r=ye(ie.selected),i={up:function(e){return e.y-=n},down:function(e){return e.y+=n},right:function(e){return e.x+=n},left:function(e){return e.x-=n}},a=B(o.x);i[e](o),r.setAttribute("transform","translate("+[o.x,o.y]+")");var c=B(o.x)===a;o.fixed&&W(ie.selected,function(t){i[e](t),c||(t.x+=2*(o.x-t.x)),this.setAttribute("transform","translate("+[t.x,t.y]+")")}),t.selectAll(".branch").attr("d",function(e){return new pe(e).draw()}),l()}function V(e,t,n){var o=ie.nodes.get(ie.selected),r=ye(ie.selected),i={name:X,fixed:te,"background-color":F,"branch-color":K,"text-color":G,"image-src":Z,"image-size":Y,"font-size":Q,italic:$,bold:ee},a=i[e];void 0!==a?!1!==a.call(r,o,t,n)&&(n||(l(),he.call("nodeupdate",r,ie.selected,o,e))):fe.error('"'+e+'" is not a valid node property')}function X(e,t,n){if(e.name==t&&!n)return!1;this.childNodes[1].childNodes[0].innerHTML=t,L(this),n||(e.name=t)}function F(e,n,o){if(e["background-color"]===n&&!o)return!1;var r=this.childNodes[0];r.style.fill=n,""!==r.style.stroke&&(r.style.stroke=t.color(n).darker(.5)),o||(e["background-color"]=n)}function G(e,t,n){if(e["text-color"]===t&&!n)return!1;this.childNodes[1].childNodes[0].style.color=t,n||(e["text-color"]=t)}function K(e,t,n){if("node0"!==ie.selected){if(e["branch-color"]===t&&!n)return!1;var o=document.getElementById("branchOf"+ie.selected);o.style.fill=o.style.stroke=t,n||(e["branch-color"]=t)}else fe.error("The root node has no branches")}function Q(e,t,n){if(e["font-size"]==t&&!n)return!1;if(this.childNodes[1].childNodes[0].style["font-size"]=t+"px",L(this),""!==e["image-src"]){var o=this.childNodes[2];o.setAttribute("y",-(o.getBBox().height+e.height/2+5))}n||(e["font-size"]=t)}function Y(e,t,n){if(""!==e["image-src"]){if(e["image-size"]==t&&!n)return!1;var o=this.childNodes[2],r=o.getBBox(),i=parseInt(t),a=r.width*i/r.height;o.setAttribute("height",i),o.setAttribute("y",-(i+e.height/2+5)),o.setAttribute("x",-a/2),n||(e["image-size"]=i)}else fe.error("The node doesn't have an image")}function Z(e,n){if(e["image-src"]===n)return!1;e["image-src"]=n,R(t.select(this),e)}function $(e){var t=fe.fontStyle(e.italic=!e.italic);this.childNodes[1].childNodes[0].style["font-style"]=t}function ee(e){var t=fe.fontWeight(e.bold=!e.bold);this.childNodes[1].childNodes[0].style["font-weight"]=t,L(this)}function te(e){"node0"!==ie.selected?e.fixed=!e.fixed:fe.error("The root node can not be fixed")}function ne(e){t.event.sourceEvent.preventDefault(),E(e.key)}function oe(e){var n=t.event.dy,o=t.event.dx,r=e.value.x+=o,i=e.value.y+=n,a=B(r)===B(r-o);if(this.setAttribute("transform","translate("+[r,i]+")"),e.value.fixed){var c=e;W(e.key,function(e){var t=e.x+=o,r=e.y+=n;a||(e.x+=2*(c.value.x-e.x)),this.setAttribute("transform","translate("+[t,r]+")")})}t.selectAll(".branch").attr("d",function(e){return new pe(e).draw()}),ie.dragged=!0}function re(){ie.dragged&&(ie.dragged=!1,l())}var ie={options:{"center-onresize":!0,drag:!0,zoom:!0,node:{name:"Node","background-color":"#f9f9f9","text-color":"#808080","branch-color":"#c2d7aa","image-src":"","image-size":60,"font-size":16,italic:!1,bold:!1,fixed:!0,padding:[30,45]},"root-node":{name:"Root node","background-color":"#f0f6f5","text-color":"#828c82","image-src":"","image-size":70,"font-size":20,italic:!1,bold:!1,fixed:!1}},history:{},svg:{}},ae=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},ce=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),se=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},le=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},de=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},ue=t.dispatch("mmcreate","mmcenter","mmundo","mmrepeat","nodeselect","nodeupdate","nodecreate","noderemove"),he=function(){function e(){ae(this,e)}return ce(e,null,[{key:"call",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];return ue.call.apply(ue,[e].concat(n))}},{key:"on",value:function(e,t){return ue.on(e,t)}}]),e}(),fe=function(){function e(){ae(this,e)}return ce(e,null,[{key:"error",value:function(e){throw new Error(e)}},{key:"cloneObject",value:function(e,t){return t?JSON.parse(JSON.stringify(e)):Object.assign({},e)}},{key:"clearObject",value:function(e){for(var t in e)delete e[t]}},{key:"fromObjectToArray",value:function(e){var t=[];for(var n in e)t.push([n,e[n]]);return t}},{key:"fontStyle",value:function(e){return e?"italic":"normal"}},{key:"fontWeight",value:function(e){return e?"bold":"normal"}},{key:"overwriteObject",value:function(e,t){for(var n in e){var o=e[n],r=t[n];void 0!==r&&r.constructor===o.constructor&&(r.constructor!==Object||Array.isArray(r)?e[n]=r:this.overwriteObject(o,r))}}},{key:"focusWithCaretAtEnd",value:function(e){e.focus();var t=document.createRange(),n=window.getSelection();t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t)}}]),e}(),ve=t.zoom().scaleExtent([.5,2]).on("zoom",y),ge=function(){function e(n,o){ae(this,e),this.node=n.value,this.dom=o,this.path=t.path(),this.random=t.randomUniform}return ce(e,[{key:"getNameDOMElement",value:function(){return this.dom.nextSibling.childNodes[0]}}]),e}(),me=function(e){function t(e,n){return ae(this,t),le(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return se(t,e),ce(t,[{key:"draw",value:function(){var e=this.getNameDOMElement();this.node.width=e.clientWidth+ie.options.node.padding[1],this.node.height=e.clientHeight+ie.options.node.padding[0],this.node.k=this.node.k||this.random(-20,20)();var t=this.node.width/2,n=this.node.height/2,o=this.node.k;return this.path.moveTo(-t,o/3),this.path.bezierCurveTo(-t,10-n,10-t,-n,o,-n),this.path.bezierCurveTo(t-10,-n,t,10-n,t,o/3),this.path.bezierCurveTo(t,n-10,t-10,n,o,n),this.path.bezierCurveTo(10-t,n,-t,n-10,-t,o/3),this.path.closePath(),this.path}}]),t}(ge),pe=function(e){function t(e){return ae(this,t),le(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return se(t,e),ce(t,[{key:"draw",value:function(){var e=ie.nodes.get(this.node.parent),t=H(this.node),n=22-3*(t<5?t:5),o=(e.x+this.node.x)/2,r=e.y<this.node.y+this.node.height/2?-1:1,i=e.x>this.node.x?-1:1,a=i*r;return this.path.moveTo(e.x,e.y-.8*n),this.path.bezierCurveTo(o-n*a,e.y-n/2,e.x-n/2*a,this.node.y+this.node.height/2-n/3,this.node.x-this.node.width/3*i,this.node.y+this.node.height/2+3),this.path.bezierCurveTo(e.x+n/2*a,this.node.y+this.node.height/2+n/3,o+n*a,e.y+n/2,e.x,e.y+.8*n),this.path.closePath(),this.path}}]),t}(ge),ye=function(e){return document.getElementById(e)},be=t.drag().on("start",ne).on("drag",oe).on("end",re),xe=he.on,we={add:N,moveTo:J,remove:M,select:E,selectTo:C,update:V};e.on=xe,e.node=we,e.version="0.1.3",e.new=A,e.init=O,e.remove=z,e.image=n,e.center=p,e.data=a,e.undo=c,e.repeat=s,e.zoomIn=g,e.zoomOut=m,Object.defineProperty(e,"__esModule",{value:!0})});